---
date: 2021-03-05
title: "STM32F407_FreeRTOS Project 생성 및 디버깅"
categories: Embedded_FreeRTOS
tags: jekyll
toc: true  
toc_sticky: true 
---

STM32F407_FreeRTOS Project 생성 및 디버깅
=============
이번 포스팅은 STM32F407 Discovery kit를 이용한 FreeRTOS Project 생성과 디버깅 Setup에 대한 내용을 정리하였습니다.

Project 생성은 Code Generator인 STM32CubeMX를 활용하였습니다.

Project 생성 후 총 3개의 LED를 각 각의 Task로 제어하는 간단한 동작을 확인하였습니다.

Uart TTL to USB 를 이용한 Log 입출력을 이용한 디버깅과 Keil의 Logic Analyzer 를 이용한 디버깅이 동작됨을 확인하였습니다.

앞으로 FreeRTOS를 공부하면서 쭈욱 활용해야하기 때문에 따로 정리하고자합니다.

# 1. STM32F407_FreeRTOS Project 생성
따로 설치법 등에 대한 내용은 생략하였습니다. 
## 1.1 STM32CubeMX
* 처음 'STM32CubeMX'를 실행하시면 아래와 같은 화면이 나옵니다.

![1](https://user-images.githubusercontent.com/79636864/110277314-56470f00-8018-11eb-9791-fe40d133679b.png)

* 아래의 사진과 같이 'File' 탭의 'New Project...'를 클릭합니다.

![2](https://user-images.githubusercontent.com/79636864/110277383-8098cc80-8018-11eb-9df9-367d604a344c.png)

* 좌측 상단의 Board Selector를 누르시고 바로 아래에 있는 'Commercial Part Number'에 Discovery kit의 모델명을 입력합니다.
* 그러면 Boards List에 Discovery kit의 정보가 나타납니다.

![3](https://user-images.githubusercontent.com/79636864/110277543-cbb2df80-8018-11eb-8262-1362bef41a8a.png)

* Boards List에 나타난 Discovery kit를 더블클릭하시면 위와 같은 창이 나오는데
* 모든 peripherals를 default Mode로 초기화의 여부를 뭍는 창이 나옵니다. Yes를 눌러줍니다.

![4](https://user-images.githubusercontent.com/79636864/110277669-146a9880-8019-11eb-986f-3e5b53d86714.png)

* Yes를 누른 후 기다리시면 아래와 같은 창이 뜨면서 여러 요소들에 대해 Configuration을 시작할 수 있습니다.

![5](https://user-images.githubusercontent.com/79636864/110277810-5dbae800-8019-11eb-8595-84f51b2cb8cb.png)

* FreeRTOS를 Enable하기 위해 좌측 하단의 'Middleware'의 'FREERTOS'를 누르고 나타나는 화면의 중단 상단의 Interface를 'CMSIS_V1'으로 설정하시면 아래와 같이 FreeRTOS 사용을 위한 Configuration을 할 수 있습니다. 각 각의 요소들에 대한 설명은 추후 공부하면서 자세하게 다루어볼 것입니다.

![6](https://user-images.githubusercontent.com/79636864/110278046-dae65d00-8019-11eb-9adc-b0dbe670ab77.png)

* FreeRTOS의 기본 동작을 확인하기 위해 아래와 같이 3개의 Task를 생성하였습니다. Task에 대한 각 각의 요소들은 모두 기본적인 값들로 설정하였습니다.

![7](https://user-images.githubusercontent.com/79636864/110278328-64962a80-801a-11eb-97cc-e3e6084c1e63.png)

* 추가적으로 FreeRTOS를 사용하고자한다면 Tick(Timebase)를 'systick' 이 아닌 'TIM1' 과 같은 Timer로 설정해야합니다.
* FreeRTOS의 스케쥴러는 ISR의 호출로 Context Switching을 해줘야하는데 여러 ISR 중 Tick(Timebase) ISR도 포함됩니다.
* 결론적으로, Tick(Timebase)를 이용해 주기적으로 ISR를 호출하고 Context Switching을 하여 Multitasking 기능을 수행할 수 있게 됩니다.
* systick를 사용하지 못하는 이유는 ARM-Cortex Achitecture에서의 대부분의 RTOS는 systick의 우선순위를 낮게 강제로 설정되기 때문입니다.(STM32CubeMX user manual의 'Setting HAL timebase source' 항목 참고)
* 자세한 내용은 추후 FreeRTOS를 공부하면서 정리해보겠습니다.

![8](https://user-images.githubusercontent.com/79636864/110279642-c2c40d00-801c-11eb-851b-e048606ddb05.png)

* 'Clock Configuration' 의 내용입니다. 전체적인 Clock들에 대한 Setting Value를 보실 수 있습니다.
* XTAL 8Mhz를 입력 받아 PLL Source Mux를 통해 STM32F407에서 지원하는 최대 클럭인 168Mhz로 만들어지는 모습입니다.
* 항상 Timer,SPI,UART,ADC 등 과 같은 기능을 사용 시, 각 기능이 어떠한 클럭을 이용하고 그 클럭이 무슨 값인지 확인해야합니다.

![9](https://user-images.githubusercontent.com/79636864/110279861-29e1c180-801d-11eb-88e1-5d65376a8a3d.png)

* 마지막으로 'Project Manager'에서 저는 Keil MDK-ARM V5 IDE를 쓰기 때문에 'Generator'항목에 내용에 맞게 변경하였습니다.

![10](https://user-images.githubusercontent.com/79636864/110279984-62819b00-801d-11eb-9bc3-9f9c7e89d7ab.png)

* 우측 상단의 'GENERATE CODE'를 누르시면 Project가 생성 됩니다.
* 모두 완료 후 해당 폴더에 가면 Project가 생성된 것을 확인할 수 있습니다.

## 1.2 IDE(Keil)
* 아래의 사진은 Project가 생성되고 Keil로 실행한 모습입니다.
* NonRTOS Project에서 RTOS 구동을 위한 소스파일들이 추가된 구조입니다.

![12](https://user-images.githubusercontent.com/79636864/110280726-a923c500-801e-11eb-97cf-a2f72e3a7b40.png)

* 생성된 Project가 이상이 없는지 확인하기 위해 'Project'-> 'Rebuild all target files'를 눌러 컴파일을 진행합니다.

![13](https://user-images.githubusercontent.com/79636864/110280895-f9028c00-801e-11eb-9356-507c8bbae127.png)

* 아래와 같이 나오면서 정상적으로 컴파일을 성공하였습니다.

![15](https://user-images.githubusercontent.com/79636864/110281156-847c1d00-801f-11eb-8b1f-9de8e250af2f.png)

# 2. STM32F407_FreeRTOS Project 디버깅 Setup
본격적으로 FreeRTOS를 공부하면서 활용하는 디버깅에 대한 Setup을 진행합니다. STM32CubeMX를 추후 사용하지 않는 다면 상관없지만 

코드를 수정하면서 STM32CubeMX를 활용하신다면, 아래의 규칙은 **무조건** 지켜주셔야합니다.
* 항상 내가 작성한 코드는 아래의 'USER CODE BEGIN'과 USER CODE END' 사이에 넣기
```
/* USER CODE BEGIN ... */
(요기)
/* USER CODE END ... */
```


## 2.2 Uart TTL to USB, printf()를 이용한 Log 입출력
* 시중에 아래의 사진과 비슷한 Uart TTL to USB tool을 구매할 수 있습니다.

(사진)

* 총 4개의 선이 있는데 각 사양은 아래와 같습니다.
```
- 빨 : 5V
- 초 : (tool기준)TXD
- 흰 : (tool기준)RXD
- 검 : GND
```
* 연결 시, 주의사항
    * 
